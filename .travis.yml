language: csharp
dist: xenial
sudo: required
mono: none

addons:
  apt:
    packages:
    - tree

  snaps:
  - name: dotnet-sdk
    confinement: classic
    channel: latest/beta

matrix:
  include:
  - os: osx
  - os: linux

script:
 - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then sudo snap alias dotnet-sdk.dotnet dotnet; fi
 - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then .CI/install-dotnet-macos.sh; fi
 - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then sed -i 's|// import appmodel 1.0|import appmodel 1.0|g' Main.qml; fi
 - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then sed -i '' 's|// import appmodel 1.0|import appmodel 1.0|g' Main.qml; fi
 - export PATH=$PATH:$(pwd)/.dotnetsdk
 - dotnet --version
 - wget --quiet -O org.hl7.fhir.validator.jar https://fhir.github.io/latest-ig-publisher/org.hl7.fhir.validator.jar
 - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then dotnet publish --configuration Release --self-contained --runtime linux-x64 /p:PublishSingleFile=true /p:PublishTrimmed=true /p:PublishReadyToRun=true; fi
 - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then dotnet publish --configuration Release --self-contained --runtime osx-x64 /p:PublishSingleFile=true /p:PublishTrimmed=true /p:PublishReadyToRun=true; fi
 - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then DEPLOY_URL=$(curl --upload-file bin/Release/netcoreapp3.0/linux-x64/publish/Hammer https://transfer.sh/Hammer); fi
 # - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then zip --output-file Hammer.zip --include bin/Release/netcoreapp3.0/linux-x64/publish/Hammer; fi
 - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then zip Hammer.zip bin/Release/netcoreapp3.0/linux-x64/publish/Hammer; fi
 - if [ "${TRAVIS_OS_NAME}" = "osx" ]; then DEPLOY_URL=$(curl --upload-file Hammer.zip https://transfer.sh/Hammer); fi
 - echo -e "Hammer is available for download at $DEPLOY_URL"

deploy:
 - provider: pages
   repo: health-validator/latest-linux
   target_branch: linux
   local_dir: bin/Release/netcoreapp3.0/linux-x64/publish
   skip_cleanup: true
   github_token: $GITHUB_TOKEN
   keep_history: false
   verbose: true
   condition: $TRAVIS_OS_NAME = linux
   on:
     branch: master

 - provider: pages
   repo: health-validator/latest-linux
   target_branch: macos
   local_dir: bin/Release/netcoreapp3.0/osx-x64/publish
   skip_cleanup: true
   github_token: $GITHUB_TOKEN
   keep_history: false
   verbose: true
   condition: $TRAVIS_OS_NAME = osx
   on:
     branch: master
